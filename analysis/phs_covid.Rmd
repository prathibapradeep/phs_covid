---
title: "PHS_Covid Analysis"
output: html_notebook
---

### **Load the datasets**

```{r}
library(tidyverse)
library(janitor)
library(here)
library(ggplot2)
library(lubridate)
library(plotly)
library(fable)
library(tsibble)
library(tsibbledata)
```

```{r}
## ---------------------------------------------------------------------------
#Load all the datafiles into dataset using loop
## ---------------------------------------------------------------------------

## List the files.

setwd("../raw_data")
files <- list.files(pattern=".csv")
## read data using loop
for (f in files) {
  file_name <- str_to_lower(str_replace(f,".csv",""))
  assign(paste(file_name),read_csv(f))
}
```

```{r}
# Function to create a theme for the plot-----------------------------------------
color_theme <- function() {
  theme(
    plot.background = element_rect(fill = "white"),
    plot.title = element_text(size = rel(2)),
    plot.title.position = "plot",
    panel.border = element_rect(colour = "blue", fill = NA, linetype = 1),
    panel.background = element_rect(fill = "white"),
    panel.grid = element_line(colour = "grey85", linetype = 1, size = 0.5),
    axis.text = element_text(colour = "blue", face = "italic", size = 12),
    axis.title.y = element_text(colour = "#1B732B", size = 10, angle = 90),
    axis.title.x = element_text(colour = "#1B732B", size = 10),
    legend.box.background = element_rect(),
    legend.box.margin = margin(6, 6, 6, 6)
  )
}
```

## **1) Analyse the Daily trend on positive cases**

```{r}
trend_hb_daily <- trend_hb_20211008 %>% 
  clean_names()
```

```{r}
#Convert the date to date format
trend_hb_daily <- trend_hb_daily %>% 
  mutate(date = as_date(ymd(date))) %>% 
  filter (year(date) == 2021)
  #filter(date >="2021-04-01") 
```

### ***Plot1(a): Trend on people who tested positive (For all the data).***

```{r}
#Plot to visualise trend on positive cases.
x <- trend_hb_daily %>% 
  filter (hb_name == "Scotland") %>% 
  ggplot()+
  aes(x = date, y = daily_positive)+
  geom_line()+
  #scale_x_date(breaks = "1 month")+
  scale_x_date(breaks = "1 month", date_labels = "%b - %y" )+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  ggtitle("Trend on Positive cases") +
  xlab("Year") +
  ylab("No of Positive Cases") +
  color_theme()

ggplotly(x)


```

### ***Plot1(b): Trend on people who tested positive(For Past 6 months).***

```{r}
x <- trend_hb_daily %>% 
  filter(date >="2021-04-01") %>% 
  filter (hb_name == "Scotland") %>% 
  ggplot()+
  aes(x = date, y = daily_positive)+
  geom_line()+
  #scale_x_date(breaks = "1 month")+
  scale_x_date(breaks = "1 month", date_labels = "%b - %y" )+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  ggtitle("People tested Positive") +
  xlab("Year") +
  ylab("No of Positive Cases") +
  color_theme()

ggplotly(x)
```

## **EXTRA 1: Forecast on Positive cases:**

```{r}
trend <- trend_hb_daily %>% 
  filter (hb_name == "Scotland") %>% 
  filter(date >="2021-06-01") %>% 
  select(date, daily_positive)

trend <- as_tsibble(trend, index = date)

fit <- trend %>%
  model(
    snaive = SNAIVE(daily_positive),
    mean_model = MEAN(daily_positive),
    arima = ARIMA(daily_positive)
  )
forecast_14days <- fit %>%
  fabletools::forecast(h = 14)
forecast_14days
```

```{r}
forecast_14days %>%
 #filter(.model == "snaive") %>%
 autoplot(trend, level = NULL) +
  ggtitle("Forecasts for Positive cases for 2 weeks") +
  xlab("Year") +
  ylab("No of Positive Cases") +
  guides(colour = guide_legend(title = "Forecast"))+
  scale_x_date(breaks = "1 month", date_labels = "%B" )+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))
```

```{r}
forecast_1month <- fit %>%
  fabletools::forecast(h = "1 month")
forecast_1month 
```

```{r}
forecast_1month %>%
 #filter(.model == "snaive") %>%
 autoplot(trend, level = NULL) +
  ggtitle("Forecasts for Positive cases for one month") +
  xlab("Year") +
  ylab("No of Positive Cases") +
  guides(colour = guide_legend(title = "Forecast"))+
  scale_x_date(breaks = "1 month", date_labels = "%B" )+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

```
```{r}
# check our available years so we know where to put the split in the data

# Now set our training data from 1992 to 2006
train <- trend %>%
  filter_index("2021-01-01" ~ "2021-08-31")

# run the model on the training set 
fit_train <- train %>%
  model(
    mean_model = MEAN(daily_positive),
    arima = ARIMA(daily_positive),
    snaive = SNAIVE(daily_positive)
  )

forecast_test <- fit_train %>% 
  fabletools::forecast(h = 30)

```

```{r}
forecast_test %>%
  autoplot(train, level = NULL) +
    autolayer(filter_index(trend, "2021-09-01" ~.), color = "black") +
    ggtitle("Forecasts for positive cases") +
    xlab("Date") + ylab("Daily Positive") +
    guides(colour=guide_legend(title="Forecast"))
```


```{r}
accuracy_model <- fabletools::accuracy(forecast_test, trend)

accuracy_model %>% 
  select(-.type) %>%
  arrange(RMSE)
```


## **2 Analyse the trend on Hospitalisations:**

```{r}
plot_hosp <- trend_hb_daily %>% 
  filter(date >="2021-04-01") %>% 
  filter (hb_name == "Scotland") %>% 
  filter(!(is.na(hospital_admissions))) %>% 
  ggplot()+
  aes(x = date, y = hospital_admissions)+
  geom_col()+
  #scale_x_date(breaks = "1 month")+
  scale_x_date(breaks = "1 week", date_labels = "%d - %b" )+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  ggtitle("Trend on Hospitalisations") +
  xlab("Date (months)") +
  ylab("No of patients admitted") +
  color_theme()

ggplotly(plot_hosp)

```


## 2 (b) Forecast on Hospitalisation:**

Using 6 months of data ( Two - Wave)

```{r}
trend_hosp <- trend_hb_daily %>% 
  filter (hb_name == "Scotland") %>% 
  filter(date >="2021-06-01") %>% 
  filter(!(is.na(hospital_admissions))) %>% 
  select(date, hospital_admissions)

trend_hosp <- as_tsibble(trend_hosp, index = date)

fit <- trend_hosp %>%
  model(
    snaive = SNAIVE(hospital_admissions),
    mean_model = MEAN(hospital_admissions),
    arima = ARIMA(hospital_admissions),
    ets = ETS(log(hospital_admissions) ~ error("M") + trend("Ad") + season("A"))
  )
forecast_14days <- fit %>%
  fabletools::forecast(h = 14)
forecast_14days
```

```{r}
forecast_14days %>%
# filter(.model == "snaive") %>%
 autoplot(trend_hosp, level = NULL) +
  ggtitle("Forecasts for Hospital admissions cases for 2 weeks") +
  xlab("Year") +
  ylab("No of patients admitted") +
  guides(colour = guide_legend(title = "Forecast"))+
  scale_x_date(breaks = "1 month", date_labels = "%B" )+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))




```

```{r}
forecast_1month <- fit %>%
  fabletools::forecast(h = "1 month")
forecast_1month 
```

```{r}
forecast_1month %>%
 filter(.model %in% c("snaive","arima")) %>%
 autoplot(trend_hosp, level = NULL) +
  ggtitle("Forecasts for Hospitalisation for one month") +
  xlab("Year") +
  ylab("No of Positive Cases") +
  guides(colour = guide_legend(title = "Forecast"))+
  scale_x_date(breaks = "1 month", date_labels = "%B" )+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

```
```{r}
#  set the training data
train <- trend_hosp %>%
  filter_index("2021-06-01" ~ "2021-08-31")

# run the model on the training set 
fit_train <- train %>%
  model(
    mean_model = MEAN(hospital_admissions),
    arima = ARIMA(hospital_admissions),
    snaive = SNAIVE(hospital_admissions),
    ets = ETS(log(hospital_admissions) ~ error("M") + trend("Ad") + season("A"))
  )

forecast_test <- fit_train %>% 
  fabletools::forecast(h = 35)

```

```{r}
forecast_test %>%
  filter(.model %in% c("arima","snaive")) %>%
  autoplot(train ) +
    autolayer(filter_index(trend_hosp, "2021-06-01" ~.), color = "black") +
    ggtitle("Forecasts for Hospitalisations") +
    facet_wrap(~.model)+
    xlab("Date") + 
    ylab("No of Patients admitted") +
    guides(colour=guide_legend(title="Forecast"))
```


```{r}
accuracy_model <- fabletools::accuracy(forecast_test, trend_hosp)

accuracy_model %>% 
  select(-.type) %>%
  arrange(RMSE)
```

Prepare the data
```{r}
daily_vacc_hb <- daily_vacc_hb_20211009 %>% 
  clean_names()
```

```{r}
 #Convert the date to date format
daily_vacc_hb <- daily_vacc_hb %>% 
  mutate(date = as_date(ymd(date)))
  #filter (year(date) == 2021)
```
```{r}
daily_vacc_hb_plot <- daily_vacc_hb %>% 
  filter(hb_name == "Scotland") %>% 
  filter(sex =="Total") %>% 
  filter(age_group == "All vaccinations") %>% 
  filter(number_vaccinated!=0) 
  #select(date,sex, age_group, number_vaccinated)
```


### ***Plot3(a): Trend on people who tested positive (For all the data).***

```{r}
#Plot to visualise trend on positive cases.
plot_vaccine <- daily_vacc_hb_plot %>% 
  ggplot()+
  aes(x = date, y = number_vaccinated)+
  geom_line(aes(color = dose))+
  facet_wrap(~dose)+
  #scale_x_date(breaks = "1 month")+
  scale_x_date(breaks = "1 month", date_labels = "%b - %y" )+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  ggtitle("Trend on Vaccination") +
  xlab("Year") +
  ylab("No of Positive Cases") +
  color_theme()

ggplotly(plot_vaccine)
```



